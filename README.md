# Переменные для умного дома с Алисой

Навык, который позволяет создавать виртуальные устройства и использовать их в навыках.
Каждое устройство может быть включено или выключено из сценария, а так же быть триггером для запуска оного.

Навык выполнен в виде функции в Яндекс Облаке.

## API

Доступ к API требует авторизации через Яндекс. Его можно получить, например, [здесь](https://oauth.yandex.ru/authorize?response_type=token&client_id=1bcfbbc93225437497bf2023d59fcabb).

Также потребуется иметь идентифкатор функции в Яндекс Облаке, где развернут этот навык.

* Получить список переменных
   ```shell
   curl https://functions.yandexcloud.net/d4eu1j29elvh2n4o6rkv \
        -H 'X-Auth-Token: <Token>'
   ```
* Добавить новую переменную
   ```shell
   curl https://functions.yandexcloud.net/d4eu1j29elvh2n4o6rkv \
        --data-urlencode 'Name=1' \
        -H 'X-Auth-Token: <Token>'
   ```
* Удалить переменную
   ```shell
   curl https://functions.yandexcloud.net/d4eu1j29elvh2n4o6rkv \
        --data-urlencode 'Name=x' \
        -H 'X-Auth-Token: <Token>'
   ```

## Выражения

Каждая переменная может иметь значение `1` или `0` (тогда их можно менять из сценариев), либо же являться выражением и вычисляться на основе значений других переменных.

Для записи формулы используется [обратная польcкая запись](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D0%B0%D1%8F_%D0%BF%D0%BE%D0%BB%D1%8C%D1%81%D0%BA%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C) и все операнды разделяются пробелами.

Например, булева формула `z & (x | y)` будет записана как `z x y | &`, где `x`, `y` и `z` — некоторые другие переменные.

## Создание и запуск навыка

**Подготовьте всё необходимое:**

1. Зарегистрируйте OAuth приложение: https://oauth.yandex.ru/client/new
2. Создайте в консоли Яндекс Облака:
    - Базу данных YDB
    - Cloud Function (Python 3.12)
3. Инициализируйте базу данных:
    ```sql
    CREATE TABLE users(
        uid Int64,
        expressions Yson,
    );
    ```

**Настройте навык Алисы:**

1. Создайте новый диалог «Умный дом»: https://dialogs.yandex.ru/developer
2. Заполните основные настройки навыка самостоятельно.
    - в качестве Backend используйте ранее созданную функцию в Яндекс Облаке
3. На вкладке «связка аккаунтов» вашего навыка настройте авторизацию, используя данные из первого шага:
    - Идентификатор приложения: `<ClientID>`
    - Секрет приложения: `<Client secret>`
    - URL авторизации: `https://oauth.yandex.ru/authorize`
    - URL для получения токена: `https://oauth.yandex.ru/token`
    - URL для обновления токена: `https://oauth.yandex.ru/token`

**Настройте функцию из первого шага:**

1. Используйте этот репозиторий в качестве исходного кода функции
2. Укажите переменные окружения в настройках функции:
    - `YDB_DATABASE`: Имя вашей базы данных YDB
    - `YDB_ENDPOINT`: Адрес для подклюения к БД
    - `OAUTH_TOKEN`: Токен в Яндекс.Диалогах (получить [здесь](https://oauth.yandex.ru/authorize?response_type=token&client_id=c473ca268cd749d3a8371351a8f2bcbd))
    - `SKILL_ID`: идентификатор вашего навыка
3. Сконфигурируйте сервисный аккаунт для функции и убедитесь, что у него есть права доступа к базе данных.

**Используйте навык!** _Возможно придется исправить мелкие баги._